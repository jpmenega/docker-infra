- hosts: all
  become: yes
  tasks:
    - name: Download Self Service Password and unarchive
      ansible.builtin.unarchive:
        src: "{{ git_source }}/samba-ad-dc/script/ltb-project-self-service-password-1.3.tar.gz"
        dest: /usr/
        remote_src: yes

    - name: Install apache httpd
      apt:
        name: apache2
        state: present

    - name: Install PHP
      apt:
        name: php
        state: present

    - name: Install libapache2-mod-php
      apt:
        name: libapache2-mod-php
        state: present

    - name: Install php-ldap
      apt:
        name: php-ldap
        state: present

    - name: Install php-mbstring
      apt:
        name: php-mbstring
        state: present

    - name: Install php-pear
      apt:
        name: php-pear
        state: present

    - name: Install php-dev
      apt:
        name: php-dev
        state: present

    - name: Install libmcrypt-dev
      apt:
        name: libmcrypt-dev
        state: present

    - name: Install pecl package PHP mcrypt
      community.general.pear:
        name: pecl/mcrypt
        state: present
        prompts:
            - (.*)libmcrypt prefix? \[autodetect\]: "autodetect"

    - name: Add mcrypt extension to php.ini
      lineinfile:
        dest: "/etc/php/7.4/apache2/php.ini"
        insertafter: ';   extension=modulename'
        line: "extension=mcrypt.so"

    - name: "Configure ltb token"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: '$keyphrase = "secret";'
        replace: '$keyphrase = "{{ ltb_token }}";'

    - name: "Configure ltb binddn"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: 'cn=manager,dc=example,dc=com'
        replace: '{{ ltb_binddn }}'

    - name: "Configure ltb bindpw"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: 'secret'
        replace: '{{ ltb_bindpw }}'

    - name: "Configure ltb base"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: 'dc=example,dc=com'
        replace: '{{ ltb_base }}'

    - name: "Configure ltb ad_mode"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: '\$ldap_login_attribute = "uid";'
        replace: '$ldap_login_attribute = "cn";'

    - name: "Configure ltb ad_mode"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: '\$ad_mode = false;'
        replace: '$ad_mode = true;'

    - name: "Configure ltb force_unlock"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: '\$ad_options\[''force_unlock''\] = false;'
        replace: '$ad_options[''force_unlock''] = true;'

    - name: "Configure ltb force_unlock"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: '\$ad_options\[''change_expired_password''\] = false;'
        replace: '$ad_options[''change_expired_password''] = true;'

    - name: "Configure ltb who_change_password"
      ansible.builtin.replace:
        path: /usr/ltb-project-self-service-password-1.3/conf/config.inc.php
        regexp: '\$who_change_password = "user";'
        replace: '$who_change_password = "manager";'

    - name: Restart Apache
      service:
        name: apache2.service
        state: restarted
